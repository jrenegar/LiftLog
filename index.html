<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Workout Tracker</title>
<style>
/* ---------------- GLOBAL ---------------- */
*, *::before, *::after {
    box-sizing: border-box;
}

/* VS Code Dark theme inspired */
body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 15px;
    background: #1e1e1e;
    color: #d4d4d4;
}

h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #569cd6;
}

/* ---------------- EXERCISE BLOCK ---------------- */
.exercise-block {
    background: #252526;
    padding: 12px 14px;
    margin: 15px auto;
    border-radius: 10px;
    max-width: 500px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    cursor: grab;
    overflow: hidden;
}

.exercise-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.exercise-header h3 {
    margin: 0;
    font-size: 19px;
    color: #4ec9b0;
}

.comment-toggle {
    background: #3c3c3c;
    color: #d4d4d4;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
}

textarea.comment {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #3c3c3c;
    background: #1e1e1e;
    color: #d4d4d4;
    resize: vertical;
    display: none;
}

/* ---------------- SETS ---------------- */
.sets {
    margin-top: 8px;
}

.set-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
}

.set-row input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #3c3c3c;
    background: #1e1e1e;
    color: #d4d4d4;
    font-size: 15px;
    min-width: 0;
}

.delete-btn {
    background: #be5046;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.delete-exercise-btn {
    background: #be5046;
    color: white;
    border: none;
    border-radius: 6px;
    width: 32px;
    height: 32px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ---------------- BUTTONS ---------------- */
.add-btn, .add-exercise-main, .import-exercises-main, .export-btn {
    width: 100%;
    padding: 13px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 12px;
}

.add-exercise-main { background: #007acc; color: #ffffff; }
.import-exercises-main { background: #28a745; color: #ffffff; }
.export-btn { background: #6f42c1; color: #ffffff; }

/* ---------------- MODALS ---------------- */
.modal-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal {
    background: #252526;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    gap: 10px;
    color: #d4d4d4;
}

.modal select, .modal textarea {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #3c3c3c;
    background: #1e1e1e;
    color: #d4d4d4;
    font-size: 16px;
}

.confirm-modal, .close-modal {
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

.confirm-modal { background: #007acc; color: white; }
.close-modal { background: #be5046; color: white; }
</style>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</head>

<body>

<h2>Workout Tracker</h2>

<div id="logContainer"></div>

<button class="add-exercise-main" onclick="openAddExerciseModal()">+ Add Exercise</button>
<button class="import-exercises-main" onclick="openImportModal()">Import Exercises</button>
<button class="export-btn" onclick="openExportModal()">Export Exercises</button>

<!-- Add Exercise Modal -->
<div id="addExerciseModalBg" class="modal-bg">
    <div class="modal">
        <h3>Select Exercise</h3>
        <select id="exerciseSelect">
            <option>Bench Press</option>
            <option>Squat</option>
            <option>Deadlift</option>
            <option>Overhead Press</option>
            <option>Barbell Row</option>
            <option>Lat Pulldown</option>
            <option>Bicep Curl</option>
            <option>Tricep Pushdown</option>
            <option>Leg Press</option>
        </select>
        <button class="confirm-modal" onclick="addExercise()">Add</button>
        <button class="close-modal" onclick="closeAddExerciseModal()">Cancel</button>
    </div>
</div>

<!-- Import Exercises Modal -->
<div id="importModalBg" class="modal-bg">
    <div class="modal">
        <h3>Import Exercises</h3>
        <p>Paste exercises here. Format: `ExerciseName [weightxreps|reps] ...`</p>
        <textarea id="importText" rows="8" placeholder="Bench Press 100x10 105x8 110x6&#10;Squat 12-15 10-12&#10;Deadlift"></textarea>
        <button class="confirm-modal" onclick="importExercises()">Import</button>
        <button class="close-modal" onclick="closeImportModal()">Cancel</button>
    </div>
</div>

<!-- Export Modal -->
<div id="exportModalBg" class="modal-bg">
    <div class="modal">
        <h3>Export Exercises</h3>
        <textarea id="exportText" rows="10" readonly></textarea>
        <button class="confirm-modal" onclick="copyExport()">Copy to Clipboard</button>
        <button class="close-modal" onclick="closeExportModal()">Close</button>
    </div>
</div>

<script>
function openAddExerciseModal() { document.getElementById("addExerciseModalBg").style.display = "flex"; }
function closeAddExerciseModal() { document.getElementById("addExerciseModalBg").style.display = "none"; }

function openImportModal() { document.getElementById("importModalBg").style.display = "flex"; }
function closeImportModal() { document.getElementById("importModalBg").style.display = "none"; document.getElementById("importText").value = ""; }

function openExportModal() { document.getElementById("exportText").value = generateExportText(); document.getElementById("exportModalBg").style.display = "flex"; }
function closeExportModal() { document.getElementById("exportModalBg").style.display = "none"; }
function copyExport() { const textarea = document.getElementById("exportText"); textarea.select(); document.execCommand("copy"); alert("Copied to clipboard!"); }

/* ---------------- EXERCISE CREATION ---------------- */
function addExercise(nameOverride = null) {
    const name = nameOverride || document.getElementById("exerciseSelect").value;
    if (!name.trim()) return;
    closeAddExerciseModal();
    createExerciseBlock(name);
    saveData();
}

function createExerciseBlock(name, comment = "", sets = []) {
    const block = document.createElement("div");
    block.className = "exercise-block";
    block.setAttribute("data-exercise", name);
    block.setAttribute("draggable", "true");

    block.innerHTML = `
        <div class="exercise-header">
            <h3>${name}</h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="comment-toggle" onclick="toggleComment(this)">Comment</button>
                <button class="delete-exercise-btn" onclick="deleteExercise(this)">×</button>
            </div>
        </div>
        <textarea class="comment" placeholder="Add comment..." oninput="saveData()">${comment}</textarea>
        <div class="sets"></div>
        <button class="add-btn" onclick="addSet(this)">+ Add Set</button>
    `;

    document.getElementById("logContainer").appendChild(block);

    sets.forEach(s => addSet(block.querySelector(".add-btn"), s.weight, s.reps));

    if (comment.trim() !== "") {
        const commentBox = block.querySelector(".comment");
        commentBox.style.display = "block";
        block.querySelector(".comment-toggle").textContent = "Hide Comment";
    }

    addDragAndDrop(block);
}

function toggleComment(btn) { const block = btn.closest(".exercise-block"); const commentBox = block.querySelector(".comment"); const isVisible = commentBox.style.display === "block"; commentBox.style.display = isVisible ? "none" : "block"; btn.textContent = isVisible ? "Comment" : "Hide Comment"; }
function deleteExercise(btn) { const block = btn.closest(".exercise-block"); if (confirm(`Delete exercise "${block.getAttribute("data-exercise")}"?`)) { block.remove(); saveData(); } }

/* ---------------- SET CONTROL ---------------- */
function addSet(button, weight = "", reps = "") {
    const setsDiv = button.parentElement.querySelector(".sets");
    const row = document.createElement("div");
    row.className = "set-row";
    row.innerHTML = `
        <input type="text" class="weight" placeholder="Weight" value="${weight}" 
               inputmode="decimal" pattern="[0-9]*" oninput="saveData()">
        <input type="text" class="reps" placeholder="Reps" value="${reps}" 
               inputmode="numeric" pattern="[0-9]*" oninput="saveData()">
        <button class="delete-btn" onclick="deleteRow(this)">×</button>
    `;
    setsDiv.appendChild(row);
    saveData();
}
function deleteRow(btn) { btn.parentElement.remove(); saveData(); }

/* ---------------- IMPORT FUNCTION ---------------- */
function importExercises() {
    const text = document.getElementById("importText").value.trim();
    if (!text) { closeImportModal(); return; }

    const lines = text.split("\n").map(l => l.trim()).filter(l => l);

    lines.forEach(line => {
        const parts = line.split(/\s+/);
        if (!parts.length) return;

        let nameParts = [];
        let tokensStartIndex = 1;

        // Detect where exercise name ends and sets begin
        for (let i = 1; i < parts.length; i++) {
            if (/\d/.test(parts[i])) { 
                tokensStartIndex = i;
                break;
            }
            nameParts.push(parts[i-1]);
        }

        const name = nameParts.length ? nameParts.join(" ") : parts[0];
        const setTokens = parts.slice(tokensStartIndex);

        let sets = [];
        let persistentWeight = null;

        setTokens.forEach(token => {
            // Format: Weight# → weight applies to all reps after
            if (token.includes("#")) {
                persistentWeight = token.replace("#", "");
                return;
            }

            // Format: WeightxReps
            if (token.includes("x")) {
                const [w, r] = token.split("x");
                sets.push({ weight: w.trim(), reps: r.trim() });
                return;
            }

            // Format: reps only
            if (!isNaN(token)) {
                sets.push({ weight: persistentWeight ?? "", reps: token });
            }
        });

        createExerciseBlock(name, "", sets);
    });

    closeImportModal();
    saveData();
}


/* ---------------- EXPORT FUNCTION ---------------- */
function generateExportText() {
    const exercises = [...document.querySelectorAll(".exercise-block")];
    let lines = [];
    exercises.forEach(ex => {
        const name = ex.getAttribute("data-exercise");
        const sets = [...ex.querySelectorAll(".set-row")]
            .filter(r => r.querySelector(".reps").value.trim() !== "")
            .map(r => {
                const w = r.querySelector(".weight").value.trim();
                const rep = r.querySelector(".reps").value.trim();
                return w ? `${w}x${rep}` : `${rep}`;
            }).join(" ");
        lines.push(`${name} ${sets}`.trim());
        const comment = ex.querySelector(".comment").value.trim();
        if (comment) lines.push(`;${comment}`);
    });
    return lines.join("\n");
}

/* ---------------- DRAG & DROP ---------------- */
function addDragAndDrop(block) {
    block.addEventListener("dragstart", (e) => { e.dataTransfer.setData("text/plain", null); block.classList.add("dragging"); });
    block.addEventListener("dragend", () => { block.classList.remove("dragging"); saveData(); });
}
const container = document.getElementById("logContainer");
container.addEventListener("dragover", e => {
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    const afterElement = getDragAfterElement(container, e.clientY);
    if (!afterElement) container.appendChild(dragging);
    else container.insertBefore(dragging, afterElement);
});
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll(".exercise-block:not(.dragging)")];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
        return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/* ---------------- SAVE / LOAD ---------------- */
function saveData() {
    const exercises = [...document.querySelectorAll(".exercise-block")];
    const data = exercises.map(ex => ({
        name: ex.getAttribute("data-exercise"),
        comment: ex.querySelector(".comment").value,
        sets: [...ex.querySelectorAll(".set-row")].map(r => ({
            weight: r.querySelector(".weight").value,
            reps: r.querySelector(".reps").value
        }))
    }));
    localStorage.setItem("workoutLog", JSON.stringify(data));
}
function loadData() {
    const saved = JSON.parse(localStorage.getItem("workoutLog") || "[]");
    saved.forEach(ex => createExerciseBlock(ex.name, ex.comment, ex.sets));
}
loadData();
</script>

</body>
</html>
